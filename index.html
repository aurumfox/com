<script>
    let walletAddress = null;

    // 1. Функция обновления интерфейса (кнопки и текста)
    function updateUI(addr) {
        const btn = document.getElementById('mainConnectBtn');
        const display = document.getElementById('walletAddr');
        
        if (addr) {
            walletAddress = addr;
            btn.innerHTML = `<span>${addr.slice(0,4)}...${addr.slice(-4)}</span>`;
            display.innerText = `Connected: ${addr}`;
            display.style.color = "#4CAF50";
        } else {
            walletAddress = null;
            btn.innerHTML = `<img src="https://phantom.app/favicon.ico" width="20"> <span>Connect Wallet</span>`;
            display.innerText = "Wallet: Not Connected";
            display.style.color = "#888";
        }
    }

    // 2. Логика для вашей верхней кнопки
    async function connect() {
        try {
            const provider = window.solana || window.phantom?.solana;
            if (!provider) {
                alert("Откройте сайт внутри кошелька Phantom!");
                return;
            }
            const resp = await provider.connect();
            updateUI(resp.publicKey.toString());
        } catch (err) {
            console.error("Ошибка:", err);
        }
    }

    // 3. Инициализация Jupiter с автоматическим отслеживанием
    function initJupiter() {
        if (window.Jupiter) {
            window.Jupiter.init({
                displayMode: "integrated",
                integratedTargetId: "jupiter-terminal",
                endpoint: "https://api.mainnet-beta.solana.com",
                formProps: {
                    initialOutputMint: "GLkewtq8s2Yr24o5LT5mzzEeccKuSsy8H5RCHaE9uRAd",
                },
            });

            // ГЛАВНОЕ: Слушаем кошелек через интервал, если Jupiter его подключил
            setInterval(() => {
                const provider = window.solana || window.phantom?.solana;
                if (provider?.publicKey && !walletAddress) {
                    updateUI(provider.publicKey.toString());
                }
            }, 1000);
        }
    }

    document.getElementById('mainConnectBtn').addEventListener('click', connect);

    window.addEventListener('load', () => {
        initJupiter();
        // Проверка при загрузке (если уже залогинены)
        setTimeout(() => {
            if (window.solana?.publicKey) {
                updateUI(window.solana.publicKey.toString());
            }
        }, 1000);
    });
</script>
