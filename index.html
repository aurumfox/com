<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alpha Fox Portal | Multi-Wallet</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/buffer/6.0.3/buffer.min.js"></script>
    <script>window.Buffer = window.Buffer || buffer.Buffer;</script>
    
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-phantom@latest/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-solflare@latest/lib/index.iife.min.js"></script>
    
    <script src="https://terminal.jup.ag/main-v2.js"></script>

    <style>
        :root { --gold: #FF8C00; --dark: #0a0a0a; --gray: #1a1a1a; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--dark); color: white; margin: 0; }
        
        /* Header */
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 20px; border-bottom: 2px solid var(--gold); background: rgba(0,0,0,0.9);
        }

        .connect-wallet-btn {
            background: #111; border: 2px solid var(--gold); color: var(--gold);
            padding: 10px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .connect-wallet-btn:hover { background: var(--gold); color: black; }

        .wallet-display { display: none; align-items: center; gap: 10px; background: var(--gray); padding: 8px 15px; border-radius: 12px; border: 1px solid #4CAF50; }

        /* Modal Wallet Picker */
        #wallet-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 10000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .wallet-modal {
            background: #151515; border: 1px solid var(--gold); border-radius: 24px;
            padding: 25px; width: 90%; max-width: 360px; text-align: center;
        }
        .wallet-option {
            width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 15px;
            border: 1px solid #333; background: #222; color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: space-between; font-weight: bold;
        }
        .wallet-option:hover { border-color: var(--gold); background: #2a2a2a; }
        .wallet-option img { width: 28px; height: 28px; }

        /* Main Content */
        .container { padding: 20px; max-width: 500px; margin: 0 auto; text-align: center; }
        .stats-card { background: var(--gray); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid #222; }
        #jupiter-terminal { width: 100%; min-height: 550px; border-radius: 16px; margin-top: 20px; }
    </style>
</head>
<body>

<div id="wallet-modal-overlay">
    <div class="wallet-modal">
        <h3 style="color: var(--gold); margin-top: 0;">Connect Wallet</h3>
        <button class="wallet-option" onclick="connectSpecificWallet('phantom')">
            <span>Phantom</span>
            <img src="https://raw.githubusercontent.com/solana-labs/wallet-adapter/master/packages/wallets/phantom/phantom.svg" alt="phantom">
        </button>
        <button class="wallet-option" onclick="connectSpecificWallet('solflare')">
            <span>Solflare</span>
            <img src="https://raw.githubusercontent.com/solana-labs/wallet-adapter/master/packages/wallets/solflare/solflare.svg" alt="solflare">
        </button>
        <button onclick="closeWalletModal()" style="background:none; border:none; color:#888; cursor:pointer; margin-top:10px;">Cancel</button>
    </div>
</div>

<header class="header">
    <div style="font-weight:bold; color:var(--gold); font-size: 1.3rem;">ALPHA FOX</div>
    <div id="wallet-area">
        <button class="connect-wallet-btn" id="mainConnectBtn" onclick="openWalletModal()">Connect Wallet</button>
        <div class="wallet-display" id="walletInfo">
            <span id="addrShort">0000...0000</span>
            <button onclick="disconnectWallet()" style="background:none; border:none; color:#ff4444; cursor:pointer; font-size:12px;">Exit</button>
        </div>
    </div>
</header>

<main class="container">
    <div class="stats-card">
        <div style="color: #888;">AFOX Balance</div>
        <div id="balance" style="font-size: 2rem; color: var(--gold); font-weight: bold; margin: 10px 0;">0.00</div>
        <div style="font-size: 0.8rem; color: #555;">Stake your tokens to earn rewards</div>
    </div>

    <div id="jupiter-terminal"></div>
</main>

<script>
    // Глобальные переменные
    let walletProvider = null;
    let connection = new solanaWeb3.Connection("https://api.mainnet-beta.solana.com");

    const modal = document.getElementById('wallet-modal-overlay');
    const connectBtn = document.getElementById('mainConnectBtn');
    const walletInfo = document.getElementById('walletInfo');
    const addrDisplay = document.getElementById('addrShort');

    // Открыть/Закрыть модалку
    function openWalletModal() { modal.style.display = 'flex'; }
    function closeWalletModal() { modal.style.display = 'none'; }

    // Логика подключения
    async function connectSpecificWallet(type) {
        try {
            if (type === 'phantom') {
                walletProvider = window.phantom?.solana || window.solana;
            } else if (type === 'solflare') {
                walletProvider = window.solflare;
            }

            if (!walletProvider) {
                alert("Wallet not found! Please install the extension or use the wallet's built-in browser.");
                return;
            }

            const resp = await walletProvider.connect();
            const publicKey = resp.publicKey.toString();
            
            // Успешное подключение
            handleAuth(publicKey);
            closeWalletModal();
        } catch (err) {
            console.error("Connection error:", err);
            alert("Connection rejected");
        }
    }

    function handleAuth(publicKey) {
        connectBtn.style.display = 'none';
        walletInfo.style.display = 'flex';
        addrDisplay.innerText = publicKey.substring(0, 4) + '...' + publicKey.substring(publicKey.length - 4);
        
        // Инициализируем Юпитер после входа
        initJupiter();
    }

    function disconnectWallet() {
        if (walletProvider) walletProvider.disconnect();
        walletInfo.style.display = 'none';
        connectBtn.style.display = 'block';
    }

    function initJupiter() {
        if (window.Jupiter) {
            window.Jupiter.init({
                displayMode: "integrated",
                integratedTargetId: "jupiter-terminal",
                endpoint: "https://api.mainnet-beta.solana.com",
                strictTokenList: false,
                defaultExplorer: "Solscan",
                formProps: {
                    fixedOutputMint: true,
                    initialOutputMint: "ВАШ_АДРЕС_ТОКЕНА_AFOX" 
                },
            });
        }
    }

    // Авто-проверка при загрузке (для мобилок)
    window.onload = () => {
        if (window.solana && window.solana.isConnected) {
            handleAuth(window.solana.publicKey.toString());
        }
    };
</script>

</body>
</html>
